# LDAP Default Group 插件

## 插件简介

LDAP Default Group 是一个为 GLPI (Gestionnaire Libre de Parc Informatique) 开发的插件，用于在 LDAP 同步用户时自动将默认分组字段设置为用户的第一个群组，并在必要时智能修复默认分组。

## 功能特点

- 在 LDAP 用户同步过程中自动设置默认分组
- 优先选择动态群组作为默认分组
- 简化用户权限管理流程
- 提高管理员工作效率

## 作者

[KISSWAM](https://github.com/KissWam)

## 许可证

GPLv2+

## 安装说明

### 前置条件

- GLPI 10.x 或 11.x 版本
- 已配置好的 LDAP 认证系统

### 安装步骤

1. 下载或克隆本插件到 GLPI 的插件目录：
   ```
   cd /path/to/glpi/plugins/
   git clone https://github.com/KissWam/ldap_default_group.git ldapdefaultgroup
   ```
   或直接将插件文件复制到 `plugins/ldapdefaultgroup/` 目录

2. 登录 GLPI 管理界面

3. 导航至 "设置" > "插件"

4. 在插件列表中找到 "LDAP Default Group"

5. 点击 "安装" 按钮

6. 安装完成后，点击 "启用" 按钮启用插件

## 配置指南

在 GLPI 后台 “设置 → 插件 → LDAP Default Group → 配置” 中可开启以下选项：

- 仅在默认分组为空时自动设置（默认开启）：尊重管理员手动选择；仅当默认分组为空或失效时自动设置
- 覆盖手动选择（默认关闭）：始终按照“动态群组优先，其次第一个普通群组”的规则重置默认分组
- 删除当前默认分组时自动修复（默认开启）：当用户当前默认分组对应的群组关系被删除时，自动选择新的默认分组或清空

插件工作原理：
1. 读取用户的群组关系（`glpi_groups_users`）
2. 优先选择动态群组作为默认分组；若无动态群组，则选择第一个普通群组
3. 当开启“仅在为空时自动设置”时，如果当前默认分组仍为有效群组，则不覆盖手动选择
4. 当删除默认分组对应的群组关系且开启“自动修复”时，重新选择默认分组；若无可选群组则清空为 0

## 使用示例

### 场景1：新用户通过LDAP同步

当新用户通过LDAP同步添加到GLPI系统时，插件会自动：
1. 获取该用户在LDAP中所属的所有群组
2. 分析这些群组在GLPI中的对应关系
3. 自动将用户的第一个群组（优先动态群组）设置为默认分组

### 场景2：现有用户信息更新

当现有用户通过LDAP同步更新信息时，插件会检查用户的群组分配是否有变化，并在必要时更新默认分组。

## 兼容性信息

| GLPI版本 | 兼容性 |
|---------|--------|
| 11.1    | ✅ 兼容 |
| 11.0.x  | ✅ 兼容 |
| 10.1.x  | ✅ 兼容 |
| 10.0.x  | ✅ 兼容 |
| 9.x     | ❌ 不兼容 |

## 故障排除

### 问题：插件未自动设置默认分组

可能的原因和解决方案：
1. 确认插件已正确安装并启用
2. 检查用户是否属于至少一个群组
3. 查看GLPI日志文件（`files/_log/`）获取详细错误信息；若页面提示“你的会话已过期。请重新登录。”请先重新登录后重试

## 更新日志

### v1.0.2
- 新增插件配置页面与三项配置开关
- 尊重手动默认分组（仅在为空或失效时自动设置）
- 当删除当前默认分组对应群组关系时自动修复
- 修复配置页权限与 CSRF 的错误

### v1.0.1
- 更新作者信息显示
- 修复兼容性问题

### v1.0.0
- 初始版本发布
- 实现LDAP用户同步时自动设置默认分组功能
- 支持优先选择动态群组

## 贡献

欢迎提交问题报告和功能请求。如需贡献代码，请提交Pull Request到[GitHub仓库](https://github.com/KissWam/ldap_default_group)。

## 联系方式

如有任何问题或建议，请通过GLPI官方论坛或[GitHub仓库](https://github.com/KissWam/ldap_default_group)联系作者。
